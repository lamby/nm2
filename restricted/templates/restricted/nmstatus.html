{% extends "restricted/base.html" %}
{% load nm %}
{% load js %}

{% block breadcrumbs %}{{block.super}} / <a href="{{person.get_absolute_url}}">{{person.lookup_key}}</a> / <a href="{% url restricted_nmstatus key=process.lookup_key %}">progress</a>{% endblock %}

{% block relatedpages %}
{{block.super}}
<a href="{{person.get_ddpo_url}}">DDPO</a>
<a href="{{person.get_ddportfolio_url}}">DDPortfolio</a>
{% if request.person.is_admin %}
<a href="{% url admin:backend_process_change process.id %}">admin</a>
{% endif %}
{% endblock %}

{% block head_resources %}
{{block.super}}
{% jsinclude "core" %}
{% endblock %}


{% block head %}
{{block.super}}
<script type="text/javascript">
$(function() {
    var prog = $("#id_progress");
    var text = $("#id_logtext");
    $("#macro_idok").click(function() {
        prog.val("{{PROGRESS_AM}}");
        text.val("ID check passed");
    });
    $("#macro_ppok").click(function() {
        prog.val("{{PROGRESS_AM}}");
        text.val("P&P check passed");
    });
    $("#macro_tsok").click(function() {
        prog.val("{{PROGRESS_AM}}");
        text.val("T&S check passed");
    });
    $("#macro_approve").click(function() {
        prog.val("{{PROGRESS_AM_OK}}");
        text.val("Application approved");
    });
    $("#macro_hold").click(function() {
        prog.val("{{PROGRESS_AM_HOLD}}");
        text.val("Set on hold because of FILLME");
    });
    $("#macro_unhold").click(function() {
        prog.val("{{PROGRESS_AM}}");
        text.val("Back from hold");
    });
});

</script>
{% endblock %}

{% block content %}

<h1>{{person.fullname}}</h1>

<h2>Personal information</h2>

<table class="personinfo">
    <tr><th>Applicant</th><td><a href="{{person.get_absolute_url}}">{{person.fullname}} &lt;{{person.email}}&gt;</a></td></tr>
    <tr><th>Account name</th><td>{{person.uid|default:"none chosen yet"}}</td></tr>
    <tr><th>OpenPGP fingerprint</th><td>{{person.fpr}}</td></tr>
    {% if process.manager %}
    <tr><th>Manager</th><td><a href="{{process.manager.get_absolute_url}}">{{process.manager.person.uid}}</a></td></tr>
    {% endif %}
    <tr>
        <th>Advocate{{process.advocates.count|pluralize}}</th>
        <td>
            {% for a in process.advocates.all %}
            <a href="{{ a.get_absolute_url }}">{{a.uid}}</a>{% if not forloop.last %},{% endif %}
            {% endfor %}
        </td>
    </tr>
    <tr><th>Process</th><td>{{person.status|desc_status}} â†’ {{process.applying_for|desc_status}}</td></tr>
    {% if can_edit %}
    <tr><th>FD comments</th><td>{{person.fd_comment}}</td></tr>
    {% endif %}
</table>
{% if can_edit %}
<a href="{% url restricted_person key=person.lookup_key %}">Edit personal information</a>
{% endif %}

<h2>Progress to become {{ process.applying_for|desc_status }}</h2>

<p>Current progress is: <b>{{ process.progress|desc_progress }}</b>.</p>

{% if can_edit %}
<form action="{% url restricted_nmstatus key=process.lookup_key %}" method="post">{% csrf_token %}
    {{ form.as_p }}
<p>
Shortcuts:
{% if process.progress == PROGRESS_AM %}
<button type="button" id="macro_idok">ID check ok</button>
<button type="button" id="macro_ppok">P&amp;P ok</button>
<button type="button" id="macro_tsok">T&amp;S ok</button>
<button type="button" id="macro_approve">Approve applicant</button>
<button type="button" id="macro_hold">On hold</button>
{% endif %}
{% if process.progress == PROGRESS_AM_HOLD %}
<button type="button" id="macro_unhold">Back from hold</button>
{% endif %}
</p>

    <input type="submit" value="Update" />
</form>
{% endif %}

<h2>Progress log</h2>

<table>
    <thead>
        <tr>
            {% if am.is_fd %}
            <th>Actions</th>
            {% endif %}
            <th>Date</th>
            <th>By</th>
            <th>Progress</th>
            <th>Text</th>
        </tr>
    </thead>
    <tbody>
    {% for l in log %}
    <tr>
        {% if am.is_fd %}
        <td><a href="{% url admin:backend_log_change l.id %}">edit</a></td>
        {% endif %}
        <td>{{l.logdate|date:"Y-m-d"}}</td>
        <td>
            <a href="{{l.changed_by.get_absolute_url}}">{{l.changed_by.uid}}</a>
        </td>
        <td>{{l.progress|desc_progress}}</td>
        <td>{{l.logtext}}</td>
    </tr>
    {% endfor %}
    </tbody>
</table>

{% endblock %}
