{% extends "public/base.html" %}
{% load nm %}
{% load js %}

{% block head_resources %}
{{block.super}}
{% jsinclude "nm" %}
{% endblock %}

{% block head %}
{{block.super}}
<script type="text/javascript">
$(function() {
    var prog = $("#id_progress");
    var text = $("#id_logtext");
    $("#macro_idok").click(function() {
        prog.val("{{PROGRESS_AM}}");
        text.val("ID check passed");
    });
    $("#macro_ppok").click(function() {
        prog.val("{{PROGRESS_AM}}");
        text.val("P&P check passed");
    });
    $("#macro_tsok").click(function() {
        prog.val("{{PROGRESS_AM}}");
        text.val("T&S check passed");
    });
    $("#macro_approve").click(function() {
        prog.val("{{PROGRESS_AM_OK}}");
        text.val("Application approved");
    });
    $("#macro_hold").click(function() {
        prog.val("{{PROGRESS_AM_HOLD}}");
        text.val("Set on hold because of FILLME");
    });
    $("#macro_unhold").click(function() {
        prog.val("{{PROGRESS_AM}}");
        text.val("Back from hold");
    });
});
</script>
{% endblock %}

{% block breadcrumbs %}{{block.super}} / <a href="{{person.get_absolute_url}}">{{person.lookup_key}}</a> / <a href="{{ process.get_absolute_url }}">progress</a>{% endblock %}

{% block relatedpages %}
{{block.super}}
<a href="{{person.get_ddpo_url}}">DDPO</a>
<a href="{{person.get_ddportfolio_url}}">DDPortfolio</a>
{% if request.person.is_admin %}
<a href="{% url admin:backend_process_change process.id %}">admin</a>
{% endif %}
{% endblock %}


{% block content %}

<h1>Status Page for {{person.fullname}}</h1>

<h2>Personal information</h2>

<table class="personinfo">
    <tr><th>Applicant</th><td><a href="{{person.get_absolute_url}}">{{person.fullname}} &lt;{{person.email}}&gt;</a></td></tr>
    <tr><th>Received application</th><td>{{started|date:"Y-m-d"}}</td></tr>
    <tr><th>Time of Last Action</th><td>{{last_change|date:"Y-m-d"}}</th></tr>
    <tr>
        <th>Advocate{{process.advocates.count|pluralize}}</th>
        <td>
            {% for a in process.advocates.all %}
            <a href="{{ a.get_absolute_url }}">{{a.uid}}</a>{% if not forloop.last %},{% endif %}
            {% endfor %}
        </td>
    </tr>
    <tr><th>Account name</th><td>{{person.uid|default:"none chosen yet"}}</td></tr>
    <tr><th>OpenPGP fingerprint</th><td>{{person.fpr|fingerprint}}</td></tr>
    {% if process.manager %}
    <tr><th>Manager</th><td><a href="{{process.manager.get_absolute_url}}">{{process.manager.person.uid}}</a></td></tr>
    {% endif %}
    <tr><th>Process</th><td>{{person.status|desc_status}} â†’ {{process.applying_for|desc_status}}</td></tr>
    <tr><th>Progress</th><td>{{process.progress|desc_progress}}</td></tr>
    <tr><th>Account created</th><td>{% if process.progress == PROGRESS_DONE %}yes{% else %}no{% endif %}</td></tr>
    {% if can_edit %}
    <tr><th>FD comments</th><td>{{person.fd_comment}}</td></tr>
    {% endif %}
</table>
{% if can_edit %}
<a href="{% url restricted_person key=person.lookup_key %}">Edit personal information</a>
{% endif %}

{% if can_edit %}

<h2>Progress to become {{ process.applying_for|desc_status }}</h2>

<p>Current progress is: <b>{{ process.progress|desc_progress }}</b>.</p>

{% if can_edit %}
<form action="{{ request.build_absolute_uri }}" method="post">{% csrf_token %}
    {{ form.as_p }}
<p>
Shortcuts:
{% if process.progress == PROGRESS_AM %}
<button type="button" id="macro_idok">ID check ok</button>
<button type="button" id="macro_ppok">P&amp;P ok</button>
<button type="button" id="macro_tsok">T&amp;S ok</button>
<button type="button" id="macro_approve">Approve applicant</button>
<button type="button" id="macro_hold">On hold</button>
{% endif %}
{% if process.progress == PROGRESS_AM_HOLD %}
<button type="button" id="macro_unhold">Back from hold</button>
{% endif %}
</p>

    <input type="submit" value="Update" />
</form>
{% endif %}

{% endif %}

<h2>Process log</h2>

<table>
<thead>
    <tr>
        {% if request.am.is_admin %}
        <th>Actions</th>
        {% endif %}
        <th>Date</th>
        <th>Changed by</th>
        <th>Progress</th>
        {% if request.am %}
        <th>Text</th>
        {% endif %}
    </tr>
</thead>
<tbody>
    {% for l in log %}
    <tr>
        {% if request.am.is_admin %}
        <td><a href="{% url admin:backend_log_change l.id %}">edit</a></td>
        {% endif %}
        <td>{{l.logdate|date:"Y-m-d"}}</td>
        <td>
            <a href="{{l.changed_by.get_absolute_url}}">{{l.changed_by.uid}}</a>
        </td>
        <td>{{l.progress|desc_progress}}</td>
        {% if request.am %}
        <td>{{l.logtext}}</td>
        {% endif %}
    </tr>
    {% endfor %}
</tbody>
</table>

<h2>Further Steps</h2>

<table>
    {% for step in steps %}
    <tr>
        {% if forloop.counter0 < curstep_idx %}
        <td>done</td>
        {% endif %}
        {% if forloop.counter0 == curstep_idx %}
        <td>current</td>
        {% endif %}
        {% if forloop.counter0 > curstep_idx %}
        <td>todo</td>
        {% endif %}
        </td>
        <td>{{step|desc_progress}}</td>
    </tr>
    {% endfor %}
</table>

{% endblock %}

