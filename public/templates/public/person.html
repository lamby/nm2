{% extends "public/base.html" %}
{% load const %}
{% load macros %}
{% load perms %}

{% macro process_table processes %}
<table>
    <thead>
        <tr>
            <th>Applicant</th>
            <th>From</th>
            <th>To</th>
            <th>Applying for</th>
            <th>Progress</th>
            <th>AM</th>
            <th>Advocate(s)</th>
            {% if request.am %}
            <th>Extras</th>
            {% endif %}
    </thead>
    <tbody>
        {% for p in processes %}
        <tr>
            <td><a href="{% url public_person key=p.person.lookup_key %}" title="{{p.person.fullname}}">{{p.person.uid|default:p.person.fullname}}</a></td>
            <td>{{p.started.date}}</td>
            <td>{{p.ended.date}}</td>
            <td>{{p.applying_for|desc_status}} ({{p.is_active|yesno:"in progress,done"}})</td>
            <td>
                {% if p.is_active %}
                <a href="{% url public_progress progress=p.progress %}">{{p.progress|desc_progress}}</a>
                {% else %}
                {{p.progress|desc_progress}}
                {% endif %}
            </td>
            <td>
                {% if p.manager %}
                <a href="{% url public_person key=p.manager.person.lookup_key %}" title="{{p.manager.person.fullname}}">{{p.manager.person.uid|default:"None"}}</a>
                {% else %}
                None
                {% endif %}
            </td>
            <td>
                {% for a in p.advocates.all %}
                <a href="{% url public_person key=a.lookup_key %}" title="{{a.fullname}}">{{a.uid}}</a>{% if not forloop.last %},{% endif %}
                {% endfor %}
            </td>
            {% if request.am %}
            <td>
                {% if p|editable_by:request.am %}
                <a href="{% url restricted_nmstatus key=p.lookup_key %}">edit</a>
                {% endif %}
            </td>
            {% endif %}
        </tr>
        {% endfor %}
    </tbody>
</table>
{% endmacro %}

{% block breadcrumbs %}{{block.super}} / <a href="{% url public_people %}">people</a> / {{person.uid|default:person.fullname}}{% endblock %}

{% block relatedpages %}
{% if request.am.is_admin %}
<a href="{% url admin:backend_person_change person.id  %}">admin</a>
{% endif %}
{% if not am %}
<a href="{% url admin:backend_am_add %}?person={{person.id}}">make am</a>
{% endif %}
{{block.super}}
{% endblock %}

{% block content %}

<h1>{{person.fullname}}</h1>

<table class="personinfo">
    <tr><th>Account name</th><td>{{person.uid|default:"None chosen yet"}}</td></tr>
    <tr><th>OpenPGP fingerprint</th><td>{{person.fpr}}</td></tr>
    <tr><th>Status</th><td>{{person.status|desc_status}}</td></tr>
    {% if am %}
    <tr>
        <th>Application manager</th>
        <td>
            {% if am.is_am %}active,{% endif %}
            {% if am.is_fd %}fd,{% endif %}
            {% if am.is_dam %}dam,{% endif %}
            {% if am.is_am_ctte %}am ctte,{% endif %}
            {{person.am.processed.count}} applicants processed
        </td>
    </tr>
    {% endif %}
</table>

{% if person|editable_by:request.am %}
<a href="{% url restricted_person key=person.lookup_key %}">edit</a>
{% endif %}

<h2>Personal history</h2>

{% usemacro process_table processes %}

{% if request.am.is_admin and not active_process %}
<a href="{% url restricted_newprocess key=person.lookup_key %}">new process</a>
{% endif %}

{% if adv_processes %}

<h2>Advocate history</h2>

{% usemacro process_table adv_processes %}

{% endif %}

{% if am %}

<h2>AM history</h2>

{% usemacro process_table am_processes %}

{% endif %}

{% endblock %}

