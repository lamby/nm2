{% extends "public/base.html" %}
{% load nm %}
{% load js %}

{% block head_resources %}
  {{block.super}}
  {% jsinclude "nm" %}
{% endblock %}

{% block breadcrumbs %}{{block.super}} / <a href="{% url 'people' %}">people</a> / {{person.uid|default:person.fullname}}{% endblock %}

{% block relatedpages %}
<a href="{{person.get_ddpo_url}}">DDPO</a>
<a href="{{person.get_portfolio_url}}">Portfolio</a>
{% if visitor %}
<a href="{% url 'restricted_minechangelogs' key=person.lookup_key %}">changelogs</a>
{% endif %}
{% if visitor.is_admin %}
<a href="{% url 'admin:backend_person_change' person.id  %}">admin</a>
{% if person.can_become_am %}
<a href="{% url 'admin:backend_am_add' %}?person={{person.id}}">make am</a>
{% endif %}
{% endif %}
{% for s in vperms.advocate_targets %}
{% if s == "dd_u" or s == "dd_nu" %}
<a href="{% url 'restricted_advocate' key=person.lookup_key applying_for=s %}">advocate for {{s|sdesc_status}}</a>
{% endif %}
{% endfor %}
{% if visitor != person %}
  {% if visitor.is_admin %}<a href="{% url 'impersonate' key=person.lookup_key %}?url={{request.build_absolute_uri}}">impersonate</a>{% endif %}
{% endif %}
{{block.super}}
{% endblock %}

{% block content %}

<h1>{{person.fullname}}</h1>

{% include "public/personinfo.html" with person=person only %}

{% if "edit_bio" in vperms.perms or "edit_ldap" in vperms.perms %}
<a href="{% url 'restricted_person' key=person.lookup_key %}">edit</a>
{% endif %}

{% if visitor == person or visitor.is_admin %}
<a href="{% url 'restricted_amprofile' key=person.lookup_key %}">edit AM</a>
{% endif %}

<h2>Short Biography</h2>

<div class="personbio">
{% if person.bio %}
  <div class="expanded">
    {{bio_html|safe}}
  </div>
  <div class="collapsed">
    {{person.bio|truncatechars:128}}{% if person.bio|length > 128 %} <span class="expander">(expand)</span>{% endif %}
  </div>
{% else %}
  (missing)
{% endif %}
</div>

<h2>Personal history</h2>

{% include "public/person_process_table.html" with p=p processes=processes only %}

{% if adv_processes %}

<h2>Advocate history</h2>

{% include "public/person_process_table.html" with p=p processes=adv_processes only %}

{% endif %}

{% if am %}

<h2>AM history</h2>

{% include "public/person_process_table.html" with p=p processes=am_processes only %}

{% endif %}

{% if audit_log %}

<h2>Audit log</h2>

<table>
  <thead>
    <tr>
      <th>Date</th>
      <th>Author</th>
      <th>Notes</th>
      <th>Changes</th>
    </tr>
  </thead>
  <tbody>
    {% for e in audit_log %}
    <tr>
      <td>{{e.logdate|date:"Y-m-d H:i:s"}}</td>
      <td><a href="{{e.author.get_absolute_url}}">{{e.author}}</a></td>
      <td>{{e.notes}}</td>
      <td>
        <ul>
        {% for field, old, new in e.changes %}
        <li>{{field}}: {{old}} â†’ {{new}}</li>
        {% endfor %}
        </ul>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>

{% endif %}

{% endblock %}
